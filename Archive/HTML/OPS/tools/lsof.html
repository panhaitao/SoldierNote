<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="lsof概述">lsof概述</h1>
<p>lsof(list open files)是一个列出当前系统打开文件的工具。在linux环境下，任何事物都以文件的形式存在，通过文件不仅仅可以访问常规数据，还可以访问网络连接和硬件。所以如传输控制协议 (TCP) 和用户数据报协议 (UDP) 套接字等，系统在后台都为该应用程序分配了一个文件描述符，无论这个文件的本质如何，该文件描述符为应用程序与基础操作系统之间的交互提供了通用接口。因为应用程序打开文件的描述符列表提供了大量关于这个应用程序本身的信息，因此通过lsof工具能够查看这个列表对系统监测以及排错将是很有帮助的。</p>
<p>lsof打开的文件可以是： Ø 普通文注：我们用sadc 收集系统动态数据，让它收集1秒之内的10次动态信息； 然后通过sar 工具来查看系统的状态。也可以用 sadf 来查看所收集的数据。 Ø 件 Ø 目录 Ø 网络文件系统的文件 Ø 字符或设备文件 Ø (函数)共享库 Ø 管道，命名管道 Ø 符号链接 Ø 网络文件（例如：NFS file、网络socket，unix域名socket） Ø 还有其它类型的文件，等等</p>
<p>lsof安装 深度服务器操作系统默认已经集成了lsof工具。</p>
<p>lsof用法 lsof语法格式： lsof ［options］ filename</p>
<p>lsof常用的option及其含义如表5.11所示。</p>
<p>表5.11 lsof常用的option及其含义 参数 含义 -a 列出打开文件存在的进程 -c 列出指定进程所打开的文件 -g 列出GID号进程详情 -d 列出占用该文件号的进程 +d 列出目录下被打开的文件 +D 递归列出目录下被打开的文件 -n 列出使用NFS的文件 -i 列出符合条件的进程。 -p 列出指定进程号所打开的文件 -u 列出UID号进程详情 -h 显示帮助信息 -v 显示版本信息</p>
<p>lsof命令的其他更多选项参数及其含义，用户可以直接运行man lsof即可查看。</p>
<p>lsof输出各列信息的意义 执行命令lsof |less，得其部分截图如下</p>
<p>在上图中各列信息的意义如下 COMMAND：进程的名称 PID：进程标识符 USER：进程所有者 FD：文件描述符，应用程序通过文件描述符识别该文件。如cwd、txt等 TYPE：文件类型，如DIR、REG等 DEVICE：指定磁盘的名称 SIZE：文件的大小 NODE：索引节点（文件在磁盘上的标识） NAME：打开文件的确切名称</p>
<p>注1：FD 列中的文件描述符cwd 值表示应用程序的当前工作目录，这是该应用程序启动的目录，除非它本身对这个目录进行更改，txt 类型的文件是程序代码，如应用程序二进制文件本身或共享库，如上列表中显示的 /sbin/init 程序。</p>
<p>其次数值表示应用程序的文件描述符，这是打开该文件时返回的一个整数。u 表示该文件被打开并处于读取/写入模式，而不是只读或只写 (w) 模式。同时还有大写 的W表示该应用程序具有对整个文件的写锁。该文件描述符用于确保每次只能打开一个应用程序实例。初始打开每个应用程序时，都具有三个文件描述符，从0到2，分别表示标准输入、输出和错误流。所以大多数应用程序所打开的文件的FD都是从3开始。</p>
<p>与FD列相比，Type列则比较直观。文件和目录分别称为REG和DIR。而CHR和BLK，分别表示字符和块设备；或者UNIX、FIFO 和 IPv4，分别表示UNIX域套接字、先进先出 (FIFO) 队列和网际协议 (IP) 套接字。</p>
<p>注2：lsof 常见的用法是查找应用程序打开的文件的名称和数目。可用于查找出某个特定应用程序将日志数据记录到何处，或者正在跟踪某个问题。例如，linux限制了进程能够打开文件的数目。通常这个数值很大，所以不会产生问题，并且在需要时，应用程序可以请求更大的值（直到某个上限）。如果你怀疑应用程序耗尽了文件描述符，那么可以使用 lsof 统计打开的文件数目，以进行验证。</p>
<p>lsof应用举例 实例1：列出某个用户打开的文件信息 lsof -u username 说明: -u 选项，u其实是user的缩写</p>
<p>实例2：列出某个程序进程所打开的文件信息 lsof -c apache 说明: -c 选项将会列出所有以mysql这个进程开头的程序的文件，其实你也可以写成 lsof | grep apache, 但是第一种方法明显比第二种方法要少打几个字符了</p>
<p>实例3：列出多个进程多个打开的文件信息 lsof -c mysql -c apache</p>
<p>实例3：列出某个用户以及某个进程所打开的文件信息 lsof -u test -c mysql</p>
<p>说明：用户与进程可相关，也可以不相关</p>
<p>实例5：列出除了某个用户外的被打开的文件信息 lsof -u ^root</p>
<p>说明：^这个符号在用户名之前，将会把是root用户打开的进程不让显示</p>
<p>实例6：通过某个进程号显示该进行打开的文件 lsof -p 1</p>
<p>实例7：列出多个进程号对应的文件信息 lsof -p 1,2,3</p>
<p>实例8：列出除了某个进程号，其他进程号所打开的文件信息 lsof -p ^1</p>
<p>实例9：列出所有的网络连接 lsof -i</p>
<p>实例10：列出所有tcp 网络连接信息 lsof -i tcp</p>
<p>实例11：列出所有udp网络连接信息 lsof -i udp</p>
<p>实例12：列出谁在使用某个端口 lsof -i :3306</p>
<p>实例13：列出谁在使用某个特定的udp端口 lsof -i udp:55</p>
<p>实例14：列出某个用户的所有活跃的网络端口 lsof -a -u test -i</p>
<p>实例15：列出所有网络文件系统 lsof -N</p>
<p>实例16：域名socket文件 lsof -U</p>
<p>实例17：某个用户组所打开的文件信息 lsof -g 5555</p>
<p>实例18：根据文件描述列出对应的文件信息 lsof -d description(like 2) 例如：lsof -d txt 例如：lsof -d 1 例如：lsof -d 2 说明：0表示标准输入，1表示标准输出，2表示标准错误，从而可知：所以大多数应用程序所打开的文件的 FD 都是从 3 开始</p>
<p>实例19：根据文件描述范围列出文件信息 lsof -d 2-3</p>
<p>实例20：列出COMMAND列中包含字符串&quot; sshd&quot;，且文件描符的类型为txt的文件信息 lsof -c sshd -a -d txt</p>
</body>
</html>
