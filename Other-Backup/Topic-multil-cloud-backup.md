# 多云容灾方案

场景


客户主要生产业务在阿里云，运行在阿里云侧业务应用, MySQL, Redis, MongoDB，现在需要将阿里云侧资源与部署在Ucloud云平台的资源组建多活容灾系统



前期准备工作


可用区	





罗马多云互通	
应用	容器应用
/普通应用？	




DNS负载均衡	
RDS	数据库类型？MySQL？默认引擎，binglog是否开启等	



支持mysql	DTS 数据集成 实时同步	
Redis	
集群版/标准版本？








支持容灾备份	
MongoDB	集群版本？副本数	




支持容灾备份	
ES	





暂不支持	
Oracle	





Ucloud 可以实现内网互通，Oracle数据同步可以寻求商业支持	
容灾方案整体概述


容灾方式
阿里云/ucloud 主从温备，默认阿里云主，ucloud从，故障后切换后，切换角色

容灾方案示意图


容灾级别
Ucloud 可以对实现同城多云 MySQL数据库实现实时同步的能力，对其他各个云厂商限制的应用可以实现定时备份的能力，Ucloud 支持多云组网能力，可以实现基础设施容灾，和数据库级容灾

数据级容灾仅将生产中心的数据复制到容灾中心，在生产中心出现故障时，仅能实现存储系统的接管或是数据的恢复。容灾中心的数据可以是本地生产数据的完全复制（在同城实现），也可以比生产数据略微落后，差异的数据可以通过一些工具（如操作记录、日志等）可以手工补回。

应用级容灾是在数据级容灾的基础上，在Ucloud侧创建和阿里云侧生产中心系统的核心资源复制，包括主机、数据库、应用、当生产系统发生灾难时，依赖第三方 DNS负载均衡实现高可用，依赖DNS将康检查，将故障侧云平台服务暂停解析，实现应用级容灾. 

构建多活业务系统对接工作
基础设置容灾	 数据库容灾	业务容灾
Ucloud提供多云互通能力支撑	ucloud提供DTS同步工具，和数据同步方案	






建议客户业务监控系统需要实现多region监控报警能力
根据需要故障手动切换/或对接DNS，对接Ucloud API 实现故障自动切换，自动恢复







开启罗马服务，并配置好vpc网段互通

 创建 DTS MySQL 同步任务源(UCloud),目标(阿里云) ，并启动启动
创建 Redis 同步任务 源(UCloud),目标(阿里云)，并启动任务
创建 ES 同步任务 源(UCloud),目标(阿里云)，并启动任务
创建 MongoDB 同步任务 源(UCloud),目标(阿里云)，并启动任务


创建 DTS MySQL 同步任务源(UCloud),目标(阿里云) ，并暂停任务
创建 Redis 同步任务 源(UCloud),目标(阿里云)，并暂停任务
创建 ES 同步任务 源(UCloud),目标(阿里云)，并暂停任务
创建 MongoDB 同步任务 源(UCloud),目标(阿里云)，并暂停任务


阿里云/UCloud 网络互通
 使用Ucloud罗马服务，实现阿里云/UCloud内网互通，即时开通，带宽可以灵活调整，同城网络延迟约4-5ms
 申请专线，打通阿里云/UCloud内网，开通周期长，带宽调整需要提前申请，网络延迟最低，网络延迟取决于运营商
无状态应用多活方案配置
应用部署支持，可以采用 ansible 等运维工具，编写配置库，在多云内网互通操作所有主机，每次更新需要时间：分钟级

RDS多活配置
在内网互通后，使用Ucloud DTS数据集成功能，可以实现全量+增量，支持mysql数据库，内网单向实时同步

Redis多活配置
使用Ucloud DTS工具，可以通过API接口操作，实现定时备份的能力，更新需要时间：分钟级

MongoDB多活配置
使用mongoshake 工具，读取MongoDB的Oplog操作日志来复制MongoDB的数据，实现内网单向实时同步

ES多活配置
目前不支持，可以提供参考在写入ES处实现在写一份ES，另外ES官方付费方案cross cluster replication支持

Oracle多活配置
Ucloud 可以实现内网互通，Oracle数据同步可以寻求商业支持

容灾故障切换与恢复
   任务阶段

          操作时间点	事项	
明细



故障主从切换阶段

从监控告警-确认故障	变更DNS解析配置	
  在DNS侧修改解析记录，去掉故障侧业务入口地址，加入备用侧业务入口地址解析  

暂停阿里云侧→ Ucloud侧同步任务	
暂停 DTS MySQL 同步任务源(阿里云),目标(UCloud) ，
暂停 Redis 同步任务 源(阿里云),目标(UCloud)，
暂停 ES 同步任务 源(阿里云),目标(UCloud)
暂停 MongoDB 同步任务 源(阿里云),目标(UCloud)


业务主从角色切换



切换完毕，流量切换至备用侧业务集群后，开始操作



准备主从角色互换，建立并启动ucloud侧→ 阿里云同步任务，

启动 DTS MySQL 同步任务源(UCloud),目标(阿里云) ，并启动任务
启动 Redis 同步任务 源(UCloud),目标(阿里云)，并启动任务
启动 ES 同步任务 源(UCloud),目标(阿里云)，并启动任务
启动 MongoDB 同步任务 源(UCloud),目标(阿里云)，并启动任务
容灾方案成本预估参考(折扣前价格)
罗马 开通费用 100元/月 + 带宽互通费用 约200元/m/月

Ucloud 侧云主机, 按照150台半数2核4G 半数 4核8G 估算 1640*7.5 + 2860*7.5

Ucloud 侧 mysql实例,  普通mysql实例  8G内存300GB存储，515*7 

Ucloud 侧 Redis实例,  主备 8G内存版本  640元/月

Ucloud 侧 Mongo实例, 16GB内存 版本    3360 元/月  * 1            

Ucloud 侧 ES实例  标准3节点版本  2100元 月  * 1 

DTS 费用目前免费
