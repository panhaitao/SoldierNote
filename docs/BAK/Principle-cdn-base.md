#  CDN的组成与原理

CDN网络架构主要分为调度中心和边缘节点两部分组成

1. 调度中心指CDN网管中心和DNS重定向解析中心，负责全局负载均衡，
2. 边缘节点也常说的CDN节点，是CDN分发网路的重要载体，主要由负载均衡设备和高速缓存服务器组成，大量分布在各个地域

当用户访问加入CDN服务的网站时，域名解析请求将最终交给全局负载均衡DNS进行处理。全局负载均衡DNS通过一组预先定义好的策略，将用户访问路径最优的节点地址提供给用户，使用户能够得到快速的服务。同时，它还与分布在其他地域的所有CDN节点保持通信，搜集各节点的通信状态，确保将用户的请求分配到可用的CDN节点上，实际上是通过DNS做全局负载均衡。
  
# 支持加速类别

* 网站
* 视频
* 直播加速

## 页面加速原理

1. 用户输入访问的域名,操作系统向 LocalDNS 查询域名的ip地址.
2. LocalDns向 ROOT DNS 查询域名的授权服务器(这里假设LocalDns缓存过期)
3. ROOT DNS将域名授权dns记录回应给 LocalDns
4. LocalDns得到域名的授权dns记录后,继续向域名授权dns查询域名的ip地址
5. 域名授权dns 查询域名记录后(一般是CNAME)，回应给 LocalDns
6. LocalDns 得到域名记录后,向智能调度DNS查询域名的ip地址
7. 智能调度DNS 根据一定的算法和策略(比如静态拓扑，容量等),将最路径最优的CDN节点IP地址回应给 LocalDns
8. 用户获取LocalDns解析到的IP地址，向获取到的IP地址发起对该资源的访问请求。
  - 如果该IP地址对应的节点已缓存该资源，则会将数据直接返回给用户，请求结束。
  - 如果该IP地址对应的节点未缓存该资源，则节点向源站发起对该资源的请求。获取资源后，结合用户自定义配置的缓存策略，将资源缓存至节点

## CDN点播/直播加速基本原理

直播和点播的区别: 对于视频点播，用户在观看的时候，可以随时选择快进和回退，直播却不能

直播就是每一帧数据打上时序标签后进行流式传输的过程。发送端源源不断的采集音视频数据，经过编码、封包、推流、再经过分发网络进行扩散传播，播放端再源源不断地下载数据并按时序进行解码播放。如此就产生了边生产、边传输、边消费的直播过程，整个流程主要分为几个关键阶段：

1. (视频采集、前处理、编码)采集视频流 
2. (推流) 推流到CDN节点（其实对于云存储来说就是个文件上传的过程）
3. (转码) CDN节点转到直播中，直播中心类似于强大的具有计算能力的中间源，可以提供额外服务诸如落存（录制，录制到云存储，可以进行点播通过CDN外链访问），转码，审核等。
4. (分发) 直播中间分发到CDN节点
5. (播放)用户播放

目前的拉流主要有三种格式：rtmp,m3u8(HLS),flv(Http-flv) 三种拉流的区别

|  协议	   |  HTTP-FLV               |      RTMP                  |   HLS                 |
| -------  | ----------------------- | -------------------------- |  -------------------- |
| 全称     | RTMP over Http          | Real Time Message Protocol | HTTP Living Streaming |
| 传输层   | HTTP长链接              | TCP 长链接                 |  HTTP短链接           |
| 视频格式 | flv                     | flv                        | TS文件（m3u8）        | 
| 原理     | 同RTMP，协议端口80      | 每个时刻数据收到立即转发   | 集合一段时间数据，生成ts 切片更新m3u8索引｜
| 延时     | 3~5s                    | 10~30s                     | 3~5s                          |
| Web支持  | H5需要插件              | H5需要插件                 | 支持                          | 
| 其他     | 播放时需要多次请求网络要求高 | 需要flash，不便于seek | 跨平台支持差需要flash插件     ｜

## 典型端到端直播CDN场景

```
主播 -> 手机摄像头-> 移动端 app - ｜               ｜ RTMP 2-3s延迟 客户端/PC
                               | -> 直播云平台 ->  ｜ HLS  5-7s延迟 html5 移动端/pc   
主播 -> 摄像头 -> PC端 obs     - ｜                ｜ RTMP/HDL 2-3s延迟  移动端/app 
```

## 页面加速和视频加速的主要区别

页面加速，主要是拉流，视频点播，直播加速主要是推流
